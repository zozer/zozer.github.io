<script type="text/javascript">
    function RSVP()
    {
        toggleAccept(true);
        toggleCard(false);
        toggleRSVP(false);
    }
    function toggleEl(val, id)
    {
        document.getElementById(id).style.display = val ? "block" : "none";
    }
    function toggleAccept(val) {
        toggleEl(val, "AcceptForm");
    }

    function toggleCard(val)
    {
        toggleEl(val, "card");
    }

    function toggleRSVP(val)
    {
        toggleEl(val, "RSVP");

    }

    function toggleThank(val)
    {
        toggleEl(val, "thank");
    }

    function toggleError(val)
    {
        toggleEl(val, "error");
    }
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    var unrolled = false;
    window.onload = function() {

        toggleAccept(false);
        toggleCard(false);
        toggleRSVP(false);
        toggleThank(false);
        toggleError(false);

        var form_id_js = "AcceptForm";
        var data_js = {
            "access_token": "6qoqzbhwoej19vc535mv2kei"
        };
        var sendButton = document.getElementById("submit_form");
        function js_send() {
            sendButton.value='Sendingâ€¦';
            sendButton.disabled=true;
            var request = new XMLHttpRequest();
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    js_onSuccess();
                } else
                if(request.readyState == 4) {
                    js_onError(request.response);
                }
            };

            //var subject = document.querySelector("#" + form_id_js + " [name='subject']").value;
            var accept = document.querySelector("#" + form_id_js + " [name='accept']").value;
            var name = document.querySelector("#" + form_id_js + " [name='name']").value;
            var email = document.querySelector("#" + form_id_js + " [name='email']").value;
            var birb = document.querySelector("#" + form_id_js + " [name='favorite']").value;
            var additionals = Array.from(document.querySelectorAll(".additional")).map(node => node.value);

            var acceptStr = accept == 0 ? "Accept" : "Reject";
            data_js['subject'] = `RSVP ${acceptStr} (${name})`;
            data_js['text'] = 
`RSVP ${acceptStr.toLowerCase()}ed for: ${name}
Email: ${email}
Additional Guest:
${additionals.map(name => `- ${name}`) .join('\n')}

Favorite Birb: ${birb}`;

            console.log(data_js['subject']);
            console.log(data_js['text']);
            var params = toParams(data_js);

            request.open("POST", "https://postmail.invotes.com/send", true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

            request.send(params);

            return false;
        }

        sendButton.onclick = js_send;

        var js_form = document.getElementById(form_id_js);
        js_form.addEventListener("submit", function (e) {
            e.preventDefault();
        });

        var searchParams = new URLSearchParams(window.location.search);
        var defaultName = searchParams.get('name');
        var defaultEmail = searchParams.get('email');
        var allowGuest = searchParams.get('type');

        document.querySelector("#" + form_id_js + " [name='name']").value = defaultName;
        document.querySelector("#" + form_id_js + " [name='email']").value = defaultEmail;
        document.querySelector("#addGuest").style.display = allowGuest == '0' ? 'block' : 'none';
    }
    async function unroll() {
        if (unrolled) {
            return;
        } else {
            unrolled = true;
            toggleCard(true);
        }
        var scroll_top = document.getElementById("scroll-top");
        var scroll_bottom = document.getElementById("scroll-bottom");
        var sheet = document.getElementById("scroll");
        for (let n = 45; n < 95; n+=0.5)
        {
            scroll_top.style.top = `${100 - n}%`;
            if ( n < 84) {
            scroll_bottom.style.top = `${n}%`;
            }

            var top = scroll_top.getBoundingClientRect();
            var bottom = scroll_bottom.getBoundingClientRect();
            sheet.style.top = top.top + top.height - 30;
            sheet.style.height = `${(bottom.top + bottom.height) - top.top - 60}`;
            await sleep(1);
        }
        toggleRSVP(true);
    }

    function js_onSuccess() {
       toggleThank(true);
       toggleAccept(false);
    }

    function js_onError(error) {
        toggleError(true);
        toggleAccept(false);
    }



    function toParams(data_js) {
        var form_data = [];
        for ( var key in data_js ) {
            form_data.push(encodeURIComponent(key) + "=" + encodeURIComponent(data_js[key]));
        }

        return form_data.join("&");
    }

    function addGuest() {
        var group = document.createElement("div");
        group.className = "form_field";
        var label = document.createElement("label");
        label.textContent = "Additional Guest:";
        var input = document.createElement("input");
        input.type = "text";
        input.className = "additional";
        group.appendChild(label);
        group.appendChild(input);
        document.getElementById("form_fields").insertBefore(group,document.getElementById("addGuest"));
    }


</script>
<link rel = "stylesheet" href = "index.css"/>
<body>
    <div class ="background" style="background-color: tan;"></div>
    <div id = "scroll-anim" class = "center absolute" onclick="unroll()">
        <div class = "center relative scroll" id = "scroll">
            <img id = "scroll-sheet" src = "scroll_middle.png"/>
            <img id = "card" src="Invite.png"/>
            <form class = "" id="AcceptForm" action="https://postmail.invotes.com/send"
        method="post" id="email_form">
                <div class = "background"></div>
                <div id = "form_fields" class="relative center fields" style="top:0%">
                    <div class = "form_field">
                        <label for="accept">Select:</label>
                        <select id = "accept" name = "accept">
                            <option value="0">Accept</option>
                            <option value="1">Decline</option>
                        </select>
                    </div>
                    <div class="form_field">
                        <label for="name">Name:</label>
                        <input type = "text" name = "name" id="name" required />
                    </div>

                    <div class="form_field">
                        <label for="email">Email:</label>
                        <input type = "text" name = "email" id="email" required />
                    </div>

                    <div class="form_field">
                        <label for="favorite">Favorite Bird:</label>
                        <input type = "text" name = "favorite" id="favorite" />
                    </div>


                    <div id="addGuest" title="Add additional family members you are RSVPing for"><p></p>
                    <button onclick="window.addGuest()" type="button">Add Family Member</button>
                    </div>

                    <div><p></p></div>
                    <input id="submit_form" type="submit" value="Send" />
                </div>
            </form>
            <div id="thank" class="absolute center">
                <h1>Thank you!</h1>
            </div>

            <div id="error" class="absolute center">
                <h1>Uh oh something went wrong!</h1>
            </div>
        </div>
        <img class = "center relative scroll" id = "scroll-top" src = "scroll_top.png">
        <div class = "center relative scroll" id = "scroll-bottom" >
            <img class = "absolute" src = "scroll_top.png" style="transform: translate(0%, -50%) scale(-1, -1);"/>
            <div class = "center absolute">
                <button id="RSVP" class = "center absolute" style="background-color: tan;" onclick="RSVP()">
                    RSVP
                </button>
            </div>
        </div>
    </div>
</body>